Написан говнокод, но вроде все работает. Построение дерева вывода еще буду проверять
